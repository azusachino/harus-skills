# mise.toml - Tool and task management for harus-skills
# https://mise.jdx.dev/

[tools]
# Formatters and linters
"npm:prettier" = "latest"           # Format markdown, JSON, YAML
"npm:markdownlint-cli" = "latest"  # Lint markdown files
"npm:@taplo/cli" = "latest"         # Format TOML files
shfmt = "latest"                    # Format shell scripts

# Git tools (optional, for enhanced workflows)
"npm:commitizen" = "latest" # Standardized commit messages

[tasks.fmt]
description = "Format all files (markdown, JSON, YAML, TOML, shell scripts)"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "Formatting files..."

# Format markdown, JSON, YAML files (config from .prettierrc.json)
prettier --write "**/*.{md,json,yaml,yml}"

# Format TOML files
taplo format "**/*.toml" 2>/dev/null || true

# Format shell scripts (if any exist)
if find . -name "*.sh" -o -name "*.bash" | grep -q .; then
  shfmt -w -i 2 -ci -bn $(find . -name "*.sh" -o -name "*.bash" | grep -v node_modules)
fi

echo "Done."
"""

[tasks.fmt-check]
description = "Check formatting without modifying files"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "Checking file formatting..."

# Check markdown, JSON, YAML (config from .prettierrc.json)
prettier --check "**/*.{md,json,yaml,yml}"

# Check TOML
taplo format --check "**/*.toml" 2>/dev/null || true

# Check shell scripts
if find . -name "*.sh" -o -name "*.bash" | grep -q .; then
  shfmt -d -i 2 -ci -bn $(find . -name "*.sh" -o -name "*.bash" | grep -v node_modules)
fi

echo "All files are properly formatted."
"""

[tasks.lint]
description = "Lint all markdown files"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”Ž Linting markdown files..."
markdownlint-cli2 "**/*.md" "#lessons/**" --config .markdownlint.json
echo "Done."
"""

[tasks.lint-fix]
description = "Lint and fix markdown files"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "Linting and fixing markdown files..."
markdownlint-cli2 "**/*.md" "#lessons/**" --fix --config .markdownlint.json
echo "Done."
"""

[tasks.clean]
description = "Remove generated lesson files"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ§¹ Cleaning generated lessons..."
rm -rf lessons/
echo "âœ… Clean complete!"
"""

[tasks.verify]
description = "Verify all skills are properly formatted"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "âœ… Verifying repository structure..."

# Check all SKILL.md files exist
for skill_dir in skills/*/; do
  skill_name=$(basename "$skill_dir")
  if [ ! -f "$skill_dir/SKILL.md" ]; then
    echo "âŒ Missing SKILL.md in $skill_name"
    exit 1
  fi
  echo "  âœ“ $skill_name has SKILL.md"
done

# Check marketplace.json
if [ ! -f ".claude-plugin/marketplace.json" ]; then
  echo "âŒ Missing .claude-plugin/marketplace.json"
  exit 1
fi
echo "  âœ“ marketplace.json exists"

# Check CLAUDE.md
if [ ! -f "CLAUDE.md" ]; then
  echo "âŒ Missing CLAUDE.md"
  exit 1
fi
echo "  âœ“ CLAUDE.md exists"

echo "âœ… Repository structure is valid!"
"""

[tasks.list-skills]
description = "List all available skills"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ“š Available skills:"
echo ""

for skill_dir in skills/*/; do
  if [ -f "$skill_dir/SKILL.md" ]; then
    skill_name=$(basename "$skill_dir")
    # Extract description from SKILL.md frontmatter
    description=$(grep "^description:" "$skill_dir/SKILL.md" | cut -d':' -f2- | xargs)
    echo "  â€¢ $skill_name"
    if [ -n "$description" ]; then
      echo "    $description"
    fi
    echo ""
  fi
done
"""

[tasks.install-hooks]
description = "Install git hooks for automated formatting"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸª Installing git hooks..."

# Create pre-commit hook
cat > .git/hooks/pre-commit << 'EOF'
#!/usr/bin/env bash
# Auto-format staged files before commit

echo "ðŸŽ¨ Auto-formatting staged files..."

# Get list of staged markdown files
STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.md$' || true)

if [ -n "$STAGED_MD" ]; then
  echo "  ðŸ“ Formatting markdown files..."
  echo "$STAGED_MD" | xargs prettier --write
  echo "$STAGED_MD" | xargs git add
fi

# Get list of staged JSON/YAML files
STAGED_DATA=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.(json|yaml|yml)$' || true)

if [ -n "$STAGED_DATA" ]; then
  echo "  ðŸ“¦ Formatting JSON/YAML files..."
  echo "$STAGED_DATA" | xargs prettier --write
  echo "$STAGED_DATA" | xargs git add
fi

echo "âœ… Pre-commit formatting complete!"
EOF

chmod +x .git/hooks/pre-commit

echo "âœ… Git hooks installed!"
echo "   Files will be auto-formatted before each commit."
"""

[tasks.check]
description = "Run all checks (format check, lint, verify)"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ” Running all checks..."
echo ""

mise run fmt-check
echo ""

mise run lint
echo ""

mise run verify
echo ""

echo "âœ… All checks passed!"
"""

[tasks.dev]
description = "Setup development environment"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ› ï¸  Setting up development environment..."

# Ensure all tools are installed
mise install

# Install git hooks
mise run install-hooks

echo "âœ… Development environment ready!"
echo ""
echo "Available commands:"
echo "  mise fmt          - Format all files"
echo "  mise lint         - Lint markdown files"
echo "  mise check        - Run all checks"
echo "  mise list-skills  - List available skills"
echo "  mise clean        - Remove generated lessons"
"""
